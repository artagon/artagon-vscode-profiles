#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<USAGE
vspcli - VS Code profile helper

Usage:
  vspcli [options]

Options:
  -l, --list                 List available profiles
  -o, --open PROFILE PATH    Open PATH with the given profile (VS Code)
  -i, --install PROFILE [--group <name> ...]
                             Install declared extensions for PROFILE (use "all" for every profile)
  -E, --install-ext PROFILE EXT
                             Install a single VS Code extension into PROFILE
  -G, --install-groups PROFILE GROUP [GROUP ...]
                             Install specific extension groups (AI, CMake, Java, Rust, General) for PROFILE
  -c, --compose [PROFILES]   Compose settings (all if none provided; pass profiles to limit)
  -x, --export [PROFILES]    Export profiles (all if none provided; pass profiles to limit)
  -O, --open-profiles [PROFILES]
                             Run open-profiles.sh (all profiles if none provided)
      --skip-install         With --open-profiles, skip installing extensions (sets VSCODE_SKIP_EXTENSION_INSTALL=1)
  -p, --profile-import PROFILE FILE
                             Import a .code-profile bundle into the named profile
  -h, --help                 Show this help message

Examples:
  vspcli --list
  vspcli --install ai-profile-crisp
  vspcli --install all
  vspcli --open ai-profile-crisp /path/to/workspace
  vspcli --install-ext rust-profile-retina github.copilot
  vspcli --install-groups java-profile-crisp AI Rust
  vspcli --compose cpp-clangd cpp-intellisense
  vspcli --export java-profile-crisp
  vspcli --open-profiles rust-profile-retina java-profile-retina
  vspcli --profile-import rust-profile-retina ~/Downloads/team-standard.code-profile

Completion:
  vspcli --completion=(bash|zsh|fish)
USAGE
}

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
SCRIPT_DIR="$ROOT/scripts"

list_profiles() {
  find "$ROOT/profiles" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort
}

profiles_space_list() {
  list_profiles | paste -sd ' '
}

open_profile() {
  local profile="$1" path="$2"
  if ! command -v code >/dev/null 2>&1; then
    echo "VS Code CLI 'code' not found" >&2
    exit 1
  fi
  code --profile "$profile" "$path"
}

install_extensions() {
  bash "$SCRIPT_DIR/install-extensions.sh" "$@"
}

install_single_extension() {
  local profile="$1" ext="$2"
  if ! command -v code >/dev/null 2>&1; then
    echo "VS Code CLI 'code' not found" >&2
    exit 1
  fi
  echo "Installing $ext for profile $profile"
  if ! code --profile "$profile" --install-extension "$ext"; then
    echo "Warning: failed to install $ext for $profile" >&2
    return 1
  fi
}

install_groups_for_profile() {
  local profile="$1"
  shift
  if [[ $# -eq 0 ]]; then
    echo "Error: --install-groups requires at least one GROUP" >&2
    exit 1
  fi
  local args=()
  for group in "$@"; do
    args+=("--group" "$group")
  done
  install_extensions "$profile" "${args[@]}"
}
compose_profiles() {
  if [[ $# -gt 0 ]]; then
    bash "$SCRIPT_DIR/compose-settings.sh" "$@"
  else
    bash "$SCRIPT_DIR/compose-settings.sh"
  fi
}

export_profiles() {
  if [[ $# -gt 0 ]]; then
    bash "$SCRIPT_DIR/export-profiles.sh" "$@"
  else
    bash "$SCRIPT_DIR/export-profiles.sh"
  fi
}

open_profiles_batch() {
  local env_skip="${OPEN_PROFILES_SKIP_INSTALL:-0}"
  if [[ $# -gt 0 ]]; then
    VSCODE_SKIP_EXTENSION_INSTALL="$env_skip" bash "$SCRIPT_DIR/open-profiles.sh" "$@"
  else
    VSCODE_SKIP_EXTENSION_INSTALL="$env_skip" bash "$SCRIPT_DIR/open-profiles.sh"
  fi
}

import_profile_bundle() {
  local profile="$1" file="$2"
  bash "$SCRIPT_DIR/import-profile.sh" "$profile" "$file"
}

print_completion() {
  local shell="$1"
  local profiles
  profiles=$(profiles_space_list)
  case "$shell" in
    bash)
      cat <<BASH
_vspcli_completions() {
  local cur prev
  COMPREPLY=()
  cur="${COMP_WORDS[COMP_CWORD]:-}"
  prev="${COMP_WORDS[COMP_CWORD-1]:-}"
  local opts="--help --list --open --install --install-ext --install-groups --compose --export --open-profiles --skip-install --profile-import"
  local profiles="$profiles"
  if [[ $cur == -* ]]; then
    COMPREPLY=( $(compgen -W "$opts" -- "$cur") )
    return 0
  fi
  case $prev in
    --open)
      COMPREPLY=( $(compgen -W "$profiles" -- "$cur") )
      return 0
      ;;
    --install|--install-ext|--install-groups)
      COMPREPLY=( $(compgen -W "$profiles" -- "$cur") )
      return 0
      ;;
    --compose|--export|--open-profiles|--profile-import)
      COMPREPLY=( $(compgen -W "$profiles" -- "$cur") )
      return 0
      ;;
  esac
}
complete -F _vspcli_completions vspcli
BASH
      ;;
    zsh)
      cat <<ZSH
#compdef vspcli
_arguments \
  '(-h --help)'{-h,--help}'[Show help]' \
  '(-l --list)'{-l,--list}'[List profiles]' \
  '(-o --open)'{-o,--open}'[Open profile + path]:profile:( $profiles ):path:_files' \
  '(-i --install)'{-i,--install}'[Install extensions]:profile:( $profiles )' \
  '(-E --install-ext)'{-E,--install-ext}'[Install extension]:profile:( $profiles ):ext:' \
  '(-G --install-groups)'{-G,--install-groups}'[Install extension groups]:profile:( $profiles ):*:group:( AI CMake Java Rust General )' \
  '(-c --compose)'{-c,--compose}'[Compose profiles]:*:profiles:( $profiles )' \
  '(-x --export)'{-x,--export}'[Export profiles]:*:profiles:( $profiles )' \
  '(-O --open-profiles)'{-O,--open-profiles}'[Run open-profiles.sh]:*:profiles:( $profiles )' \
  '--skip-install[Skip extension installs with --open-profiles]' \\
  '(-p --profile-import)'{-p,--profile-import}'[Import .code-profile]:profile:( $profiles ):file:_files'
ZSH
      ;;
    fish)
      cat <<FISH
function __vspcli_profiles
  echo $profiles
end
complete -c vspcli -l help -d 'Show help'
complete -c vspcli -l list -d 'List profiles'
complete -c vspcli -l open -d 'Open profile/path' -a '(__vspcli_profiles)'
complete -c vspcli -l install -d 'Install extensions' -a '(__vspcli_profiles)'
complete -c vspcli -l install-ext -d 'Install single extension' -a '(__vspcli_profiles)'
complete -c vspcli -l install-groups -d 'Install extension groups' -a '(__vspcli_profiles)'
complete -c vspcli -l compose -d 'Compose profiles' -a '(__vspcli_profiles)'
complete -c vspcli -l export -d 'Export profiles' -a '(__vspcli_profiles)'
complete -c vspcli -l open-profiles -d 'Run open-profiles.sh' -a '(__vspcli_profiles)'
complete -c vspcli -l skip-install -d 'Skip extension installs with --open-profiles'
complete -c vspcli -l profile-import -d 'Import .code-profile' -a '(__vspcli_profiles)'
FISH
      ;;
    *)
      echo "Unsupported shell for completion" >&2
      exit 1
      ;;
  esac
}

if [[ ${1:-} == "--completion" ]]; then
  if [[ $# -lt 2 ]]; then
    echo "Specify bash, zsh, or fish" >&2
    exit 1
  fi
  print_completion "$2"
  exit 0
fi

action_taken=0
while [[ $# -gt 0 ]]; do
  case "$1" in
    -l|--list)
      list_profiles
      action_taken=1
      shift
      ;;
    -o|--open)
      if [[ $# -lt 3 ]]; then
        echo "Error: --open requires PROFILE and PATH" >&2
        echo "Available profiles:" >&2
        list_profiles >&2
        exit 1
      fi
      open_profile "$2" "$3"
      action_taken=1
      shift 3
      ;;
    -i|--install)
      shift
      if [[ $# -eq 0 ]]; then
        echo "Error: --install requires PROFILE" >&2
        echo "Available profiles:" >&2
        list_profiles >&2
        exit 1
      fi
      profile="$1"
      shift
      args=()
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --group|--groups)
            if [[ $# -lt 2 ]]; then
              echo "Error: $1 requires a value" >&2
              exit 1
            fi
            args+=("$1" "$2")
            shift 2
            ;;
          *)
            break
            ;;
        esac
      done
      install_extensions "$profile" "${args[@]}"
      action_taken=1
      ;;
    -G|--install-groups)
      shift
      if [[ $# -lt 2 ]]; then
        echo "Error: --install-groups requires PROFILE and at least one GROUP" >&2
        echo "Available profiles:" >&2
        list_profiles >&2
        exit 1
      fi
      profile="$1"
      shift
      groups=()
      while [[ $# -gt 0 && "${1:0:1}" != '-' ]]; do
        groups+=("$1")
        shift
      done
      if [[ ${#groups[@]} -eq 0 ]]; then
        echo "Error: --install-groups requires at least one GROUP" >&2
        exit 1
      fi
      install_groups_for_profile "$profile" "${groups[@]}"
      action_taken=1
      ;;
    -E|--install-ext)
      if [[ $# -lt 3 ]]; then
        echo "Error: --install-ext requires PROFILE and EXTENSION ID" >&2
        exit 1
      fi
      install_single_extension "$2" "$3"
      action_taken=1
      shift 3
      ;;
    -c|--compose)
      shift
      if [[ $# -gt 0 && "${1:0:1}" != '-' ]]; then
        args=()
        while [[ $# -gt 0 && "${1:0:1}" != '-' ]]; do
          args+=("$1")
          shift
        done
        compose_profiles "${args[@]}"
      else
        compose_profiles
      fi
      action_taken=1
      ;;
    -x|--export)
      shift
      if [[ $# -gt 0 && "${1:0:1}" != '-' ]]; then
        args=()
        while [[ $# -gt 0 && "${1:0:1}" != '-' ]]; do
          args+=("$1")
          shift
        done
        export_profiles "${args[@]}"
      else
        export_profiles
      fi
      action_taken=1
      ;;
    -O|--open-profiles)
      shift
      args=()
      while [[ $# -gt 0 ]]; do
        case "$1" in
          --skip-install)
            OPEN_PROFILES_SKIP_INSTALL=1
            args+=("$1")
            shift
            ;;
          -*)
            break
            ;;
          *)
            args+=("$1")
            shift
            ;;
        esac
      done
      if [[ ${#args[@]} -gt 0 ]]; then
        open_profiles_batch "${args[@]}"
      else
        open_profiles_batch
      fi
      action_taken=1
      ;;
    --skip-install)
      OPEN_PROFILES_SKIP_INSTALL=1
      shift
      ;;
    -p|--profile-import)
      if [[ $# -lt 3 ]]; then
        echo "Error: --profile-import requires PROFILE and FILE" >&2
        exit 1
      fi
      import_profile_bundle "$2" "$3"
      action_taken=1
      shift 3
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ $action_taken -eq 0 ]]; then
  usage
  exit 1
fi
